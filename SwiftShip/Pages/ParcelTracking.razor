@page "/parceltracking"

@using SwiftShip.BusinessLogic.Models;
@using SwiftShip.BusinessLogic;
@using SwiftShip.Database.Enums;
@inject IParcelStageHistoryBusinessLogic _parcelStageBusinessLogic
@inject IStageBusinessLogic _stageBusinessLogic

<DxGrid @ref="Grid"
        Data="DataSource"
        PageSize="12"
        KeyFieldName="Id"
        ValidationEnabled="true"
        CustomizeEditModel="Grid_CustomizeEditModel"
        EditModelSaving="Grid_EditModelSaving"
        PopupEditFormCssClass="pw-800"
        EditMode="@CurrentEditMode">
    <Columns>
        <DxGridCommandColumn Width="160px" NewButtonVisible="false" DeleteButtonVisible="false" />
        <DxGridDataColumn FieldName="@nameof(ParcelStageModel.Identifier)" />
        <DxGridDataColumn FieldName="@nameof(ParcelStageModel.Stage)" />
        <DxGridDataColumn FieldName="@nameof(ParcelStageModel.Address)" />
    </Columns>
    <EditFormTemplate Context="EditFormContext">
        @{
            var currentModel = (ParcelStageModel)EditFormContext.EditModel;
        }
        <DxFormLayout CssClass="w-100">
            <DxFormLayoutItem Caption="Address:" ColSpanMd="6">
                @EditFormContext.GetEditor("Address")
            </DxFormLayoutItem>

            <DxFormLayoutItem Caption="State" ColSpanMd="6">
                <DxComboBox Data="CurrentStages" @bind-Value="currentModel.Stage" Enabled="@isDropDownVisible" SelectedItemChanged="@((StageType city) => OnItemChanged(city))">
                </DxComboBox>
            </DxFormLayoutItem>
        </DxFormLayout>
    </EditFormTemplate>
</DxGrid>

@code {
    IEnumerable<ParcelStageModel> DataSource { get; set; }
    IGrid Grid { get; set; }
    GridEditMode CurrentEditMode = GridEditMode.EditForm;
    TaskCompletionSource<bool> DataLoadedTcs { get; } = new(TaskCreationOptions.RunContinuationsAsynchronously);
    private StageType SelectedStage;
    private List<StageType> CurrentStages = new List<StageType>();
    private bool isComboBoxPopupVisible = false;
    private bool isDropDownVisible = true;

    protected override async Task OnInitializedAsync()
    {
        DataSource = await _parcelStageBusinessLogic.GetAllAsync();
    }

    public void Dispose()
    {
        DataLoadedTcs.TrySetCanceled();
    }

    void Grid_CustomizeEditModel(GridCustomizeEditModelEventArgs e)
    {
        var model = (ParcelStageModel)e.EditModel;
        if (string.IsNullOrEmpty(model.Address))
            isDropDownVisible = false;
        else
        {
            isDropDownVisible = true;
            GetFilteredStages(((ParcelStageModel)e.EditModel).Stage);
        }
    }

    async Task Grid_EditModelSaving(GridEditModelSavingEventArgs e)
    {
        var parcel = (ParcelStageModel)e.EditModel;
        await _parcelStageBusinessLogic.AddAsync(parcel);
        await UpdateDataAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            DataLoadedTcs.TrySetResult(true);
    }

    private void GetFilteredStages(StageType selectedStageType)
    {
        CurrentStages = _stageBusinessLogic.GetStageOptions(selectedStageType);
    }

    private void OnItemChanged(StageType newSelection)
    {
        //currentModel.Address = "";
        isDropDownVisible = false;
    }

    async Task UpdateDataAsync()
    {
        DataSource = await _parcelStageBusinessLogic.GetAllAsync();
    }
}
